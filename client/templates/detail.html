<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dettaglio Emergenza - RescueCom</title>
    <!-- Icone Bootstrap -->
    <link rel="stylesheet" href="{{ url_for('static', filename='lib/bootstrap-icons/bootstrap-icons.css') }}">
    <!-- Riutilizzo lo stesso Foglio di stile CSS della Dashboard per coerenza -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    <!-- Stile specifico per il dettaglio -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/detail.css') }}">
</head>

<body>

    <!-- Logica di caricamento dati robusta: Supporta sia 'req' che 'request' e fallback su Demo -->
    <!-- Logica di init dati (Flat Scope per evitare bug di variabili locali) -->
    <!-- 1. Fallback Layout Vuoto -->
    {% set fallback_data = {
    'id': '', 'emtype': '', 'emscore': '', 'emposition': '', 'emdescription': '',
    'name': '', 'surname': '', 'birthday': '', 'age': '', 'bloodtype': '',
    'healthinfo': {'malattie': '', 'allergie': '', 'disabilita': ''},
    'empicture': ''
    } %}

    <!-- 2. Rilevamento dati da oggetto 'request' (vecchio viewer) -->
    {% set legacy_data = request if (request is defined and request.healthinfo is defined) else fallback_data %}

    <!-- 3. Selezione finale: 'req' (se passato) o legacy/fallback -->
    {% set req = req if (req is defined and req is not none) else legacy_data %}


    <!-- Intestazione condivisa -->
    <header>
        <div class="header-right">
            <a href="/dashboard"
                style="text-decoration: none; color: white; display: flex; align-items: center; gap: 5px;">
                <i class="bi bi-arrow-left"></i> Torna alla Dashboard
            </a>
        </div>
    </header>

    <div class="container" style="max-width: 800px; margin: 40px auto; padding: 0 20px;">
        <!-- Header Emergenza -->
        <div class="header-detail"
            style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 30px; border-bottom: 1px solid #e2e8f0; padding-bottom: 20px;">
            <div>
                <h1 style="font-size: 2rem; margin: 0; color: #1e293b; font-weight: 800;">{{ req.get('emtype',
                    'Emergenza') }}</h1>
                <div style="color: #64748b; margin-top: 5px; font-family: monospace;">ID: {{ req.get('id', 'N/A') }}
                </div>
            </div>
            <!-- Badge Priorità -->
            {% set score = req.get('emscore', 0)|int %}
            {% set priority_class = 'bg-lieve' %}
            {% if score >= 80 %} {% set priority_class = 'bg-grave' %}
            {% elif score >= 40 %} {% set priority_class = 'bg-moderato' %}
            {% endif %}

            <div class="priority-badge {{ priority_class }}">
                PRIORITY SCORE: {{ score }}
            </div>
        </div>

        <!-- Griglia Info -->
        <div class="card-details"
            style="background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 30px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">

            <!-- Gruppo 1: Paziente -->
            <div class="info-group">
                <div class="info-label">Dati Paziente</div>
                <div class="info-value" style="font-size: 1.1rem;">
                    <strong>{{ req.get('name', 'Nome Sconosciuto') }} {{ req.get('surname', '') }}</strong>
                </div>
                <div class="info-value">
                    <span style="color: #64748b;">Nascita:</span> {{ req.get('birthday', 'N/A') }} &nbsp;•&nbsp;
                    <span style="color: #64748b;">Gruppo:</span>
                    {% if req.get('bloodtype') %}
                    <span class="health-badge info">Gr. {{ req.get('bloodtype') }}</span>
                    {% else %} <span style="color: #94a3b8;">N/A</span> {% endif %}
                </div>
            </div>

            <!-- Gruppo 2: Salute -->
            <div class="info-group">
                <div class="info-label">Info Sanitarie</div>
                <div style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px;">
                    {% set health = req.get('healthinfo', {}) %}

                    {# Handle both dict and legacy object #}
                    {% set malattie = health.get('malattie', '') if health.get else health.malattie|default('') %}
                    {% set allergie = health.get('allergie', '') if health.get else health.allergie|default('') %}
                    {% set disabilita = health.get('disabilita', '') if health.get else health.disabilita|default('') %}

                    <!-- Malattie -->
                    {% if malattie and malattie|lower != 'nessuna' %}
                    {% for m in malattie.split(',') %}
                    <span class="health-badge warning">{{ m|trim }}</span>
                    {% endfor %}
                    {% endif %}

                    <!-- Allergie -->
                    {% if allergie and allergie|lower != 'nessuna' %}
                    {% for a in allergie.split(',') %}
                    <span class="health-badge warning">Allergia: {{ a|trim }}</span>
                    {% endfor %}
                    {% endif %}

                    <!-- Disabilità -->
                    {% if disabilita and disabilita|lower != 'nessuna' %}
                    <span class="health-badge neutral">Disabilità: {{ disabilita }}</span>
                    {% endif %}

                    {% if not malattie and not allergie %}
                    <span class="health-badge neutral">Nessuna patologia nota</span>
                    {% endif %}
                </div>
                <!-- Raw text fallback for debugging unknown structures -->
                <div style="font-size: 0.8rem; color: #cbd5e1; margin-top: 8px;">
                    <!-- Debug: {{ health }} -->
                </div>
            </div>

            <hr style="border: 0; border-top: 1px dashed #cbd5e1; margin: 25px 0;">

            <!-- Gruppo 3: Emergenza -->
            <div class="info-group">
                <div class="info-label">Luogo & Descrizione</div>
                <div class="info-value" style="font-size: 1.05rem; line-height: 1.6; color: #334155;">
                    {{ req.get('emdescription', 'Nessuna descrizione disponibile.') }}
                </div>
                <div class="info-value"
                    style="margin-top: 10px; font-size: 0.95rem; background: #f8fafc; padding: 10px; border-radius: 6px; border: 1px solid #e2e8f0;">
                    <i class="bi bi-geo-alt-fill" style="color: #ef4444;"></i>
                    <strong>Posizione:</strong> {{ req.get('emposition', 'Posizione non rilevata') }}
                </div>
            </div>

            <!-- Gruppo 4: Foto -->
            {% if req.get('empicture') %}
            <div class="info-group">
                <div class="info-label">Media Allegati</div>
                <img src="{{ req.empicture }}" alt="Scena Emergenza"
                    style="width: 100%; max-height: 400px; object-fit: cover; border-radius: 8px; border: 1px solid #cbd5e1; margin-top: 5px;"
                    onerror="this.style.display='none'">
            </div>
            {% endif %}

            <!-- Azioni -->
            <div class="action-bar" style="margin-top: 30px;">
                <button class="btn-sm-primary" style="background-color: #64748b;" onclick="window.print()">
                    <i class="bi bi-printer"></i> Stampa
                </button>
                <button class="btn-sm-primary" style="background-color: #22c55e;"
                    onclick="alert('Funzionalità non attiva nella demo')">
                    <i class="bi bi-telephone-fill"></i> Contatta Soccorritore
                </button>
            </div>

        </div>
    </div>

</body>

</html>