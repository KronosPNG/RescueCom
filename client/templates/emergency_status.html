{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <h2 class="mb-4">Dettaglio Richiesta</h2>

    <div class="card shadow-sm">
        <div class="card-body">

            <!-- Header: ID, Priorità, Stato -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <strong>
                    ID: {{ single_emergency.emergency_id }} |
                    PRIORITÀ: {{ single_emergency.severity }}
                </strong>
                <span class="badge bg-secondary">
                    {% if single_emergency.resolved %}Accettata{% else %}In corso{% endif %}
                </span>
            </div>

            <!-- Tipo emergenza -->
            <h5>Tipo emergenza</h5>
            <p>{{ single_emergency.emergency_type }}</p>

            <!-- Data -->
            <h5>Data creazione</h5>
            <p>{{ single_emergency.created_at.strftime('%d/%m/%Y %H:%M') }}</p>

            <!-- MAPPA -->
            {% if single_emergency.position %}
            <h5>Posizione</h5>
            <div id="map"
                 style="height: 300px; width: 100%; display: none;"
                 class="mb-3">
            </div>
            {% endif %}

            <!-- Descrizione -->
            <h5>Descrizione</h5>
            <p>{{ single_emergency.description }}</p>

            <!-- Foto -->
            {% if single_emergency.photo_b64 %}
            <h5>Foto</h5>
            <img src="data:image/jpeg;base64,{{ single_emergency.photo_b64 }}"
                 alt="Foto emergenza"
                 class="img-fluid">
            {% endif %}

            <!-- Dettagli JSON -->
            {% if single_emergency.details_json %}
            <h5 class="mt-3">Dettagli</h5>
            <div data-json='{{ single_emergency.details_json }}'></div>
            {% endif %}

            <!-- Pulsanti -->
            <a href="/edit/{{ single_emergency.emergency_id }}"
               class="btn btn-primary mt-3">
                Modifica richiesta
            </a>

            <a href="/myemergencies/"
               class="btn btn-secondary mt-3">
                Torna indietro
            </a>

        </div>
    </div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
    if (typeof L !== "undefined") {

        const mapDiv = document.getElementById('map');
        mapDiv.style.display = "block";

        const map = L.map(mapDiv).setView(
            [{{ single_emergency.position[0] }}, {{ single_emergency.position[1] }}],
        13
    );

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        L.marker([
            {{ single_emergency.position[0] }},
        {{ single_emergency.position[1] }}
    ]).addTo(map);

        setTimeout(() => {
            map.invalidateSize();
        }, 100);
    }
</script>
{% endblock %}